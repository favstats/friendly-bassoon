---
title: "regressions"
output: html_notebook
---
# Loading in Functions

```{r}
#rm(list=ls())

source("scripts/helper_functions.R")
options(scipen = 999)

```


# Loading the Packages

```{r}


# pacman::p_install_gh("systats/tidyTX")
# pacman::p_install_gh("systats/tidyMBO")
#pacman::p_install_gh("favstats/favstats")
pacman::p_load(tidyverse, haven, sjPlot, sjmisc, sjstats,
                     forcats, weights, car, lme4,
                     countrycode, ggthemes,
                     survey, reshape2, favstats,
                     magrittr, rlist, tidyMBO, tidyTX,
                     ggstance)


memory.limit()
memory.limit(size=40000)
```

# Loading in Data

```{r}
load("data/combined.Rdata")

combined_dem <- combined %>% 
  filter(regime == "demo") %>% 
  mutate_at(vars(gov_trust:trust_courts, wvs:polity_autodummy, discuss, gdp10:urbanratio10), range01) %>% 
  mutate(pop10 = log(pop10+1)) %>% 
  mutate(gdp10 = log(gdp10+1)) 

combined_nondem <- combined %>% 
  filter(regime != "demo") %>% 
  mutate_at(vars(gov_trust:trust_courts, wvs:polity_autodummy, discuss, gdp10:urbanratio10), range01) %>% 
  mutate(pop10 = log(pop10+1)) %>% 
  mutate(gdp10 = log(gdp10+1)) 

combined %<>% 
  mutate(pop10 = log(pop10+1)) %>% 
  mutate(gdp10 = log(gdp10+1)) 


combined %>% 
  filter(urbanratio10 > 0.01)
```



# Regressions

## Complete Sample

### Null Model

```{r}
fit0_no <- lmer(gov_trust ~ 1 +
                 (1|cntry), data = combined, weights = weight)

fit0_low <- lmer(gov_trust_low ~ 1 +
                 (1|cntry), data = combined, weights = weight)

fit0_high <- lmer(gov_trust_high ~ 1 +
                 (1|cntry), data = combined, weights = weight)

icc(fit0_no)
icc(fit0_low)
icc(fit0_high)
```


### W/O Delibs

```{r}

list(
lmer(gov_trust ~ income + educ + 
                              work + age + sex + 
                              pop10 + gdp10 + lifeexp10 + urbanratio10 +
                              afro + latino + americas + asian + ESS +
                              (1|cntry), data = combined, weights = weight),

lmer(gov_trust_low ~ income + educ + 
                              work + age + sex + 
                              pop10 + gdp10 + lifeexp10 + urbanratio10 +
                              afro + latino + americas + asian + ESS +
                              (1|cntry), data = combined, weights = weight),

lmer(gov_trust_high ~ income + educ + 
                              work + age + sex + 
                              pop10 + gdp10 + lifeexp10 + urbanratio10 +
                              afro + latino + americas + asian + ESS +
                              (1|cntry), data = combined, weights = weight)
) -> just_controls

# delibs <- combined %>% select(delib10, consult10, reason10, common10, countr10, engage10)

# 
# mods_no <- names(delibs) %>%
#   purrr::map(progressively(multilevels_no, .n = length(delibs)))
# 
# mods_low <- names(delibs) %>%
#   purrr::map(progressively(multilevels_low, .n = length(delibs)))
# 
# mods_high <- names(delibs) %>%
#   purrr::map(progressively(multilevels_high, .n = length(delibs)))
# 
# rbind(
# mods_no %>%
#   purrr::map(broom::tidy) %>%
#   purrr::map(~create_col(., term)) %>%
#   bind_rows() %>%
#   mutate(bias = "no") %>%
#   na.omit() %>%
# left_join(mods_no %>%
#   purrr::map(p_value) %>%
#   purrr::map(~create_col(., term)) %>%
#   bind_rows()),
# 
# mods_low %>%
#   purrr::map(broom::tidy) %>%
#   purrr::map(~create_col(., term)) %>%
#   bind_rows() %>%
#   mutate(bias = "low") %>%
#   na.omit() %>%
# left_join(mods_low %>%
#   purrr::map(p_value) %>%
#   purrr::map(~create_col(., term)) %>%
#   bind_rows()),
# 
# mods_high %>%
#   purrr::map(broom::tidy) %>%
#   purrr::map(~create_col(., term)) %>%
#   bind_rows() %>%
#   mutate(bias = "high") %>%
#   na.omit() %>%
# left_join(mods_high %>%
#   purrr::map(p_value) %>%
#   purrr::map(~create_col(., term)) %>%
#   bind_rows())
# ) -> wo_controls
# 
# wo_controls %>%
#   janitor::clean_names() %>%
#   mutate(stars = get_p_values(p_value)) %>%
#   filter(term %nin% c("sex","income","educ",
#                            "work", "age", "sex",
#             "afro", "latino", "americas", "asian", "ESS",
#             "(Intercept)")) %>%
#   mutate(term_cite = term) %>%
#   mutate(term = case_when(
#     term == "delib10" ~ "Deliberation Component Index",
#     term == "reason10" ~ "Reasoned Justification",
#     term == "common10" ~ "Common Good",
#     term == "countr10" ~ "Counter-Arguments",
#     term == "consult10" ~ "Range of Consultation",
#     term == "engage10" ~ "Engaged Society"
#   )) %>%
#   mutate(term = factor(term,
#                        levels = rev(c("Deliberation Component Index",
#                                            "Reasoned Justification",
#                                            "Common Good",
#                                            "Counter-Arguments",
#                                            "Range of Consultation",
#                                            "Engaged Society"))))
# # 


```
### With Controls

```{r}



delibs <- combined %>% select(delib10, consult10, reason10, common10, countr10, engage10)

mods1_c <- names(delibs) %>% 
  purrr::map(progressively(multilevels_no_c, length(delibs)))

mods2_c <- names(delibs) %>% 
  purrr::map(progressively(multilevels_low_c, length(delibs)))

mods3_c <- names(delibs) %>% 
  purrr::map(progressively(multilevels_high_c, length(delibs)))

# mods1_c_reml <- names(delibs) %>% 
#   purrr::map(~multilevels_no_c(.x, REML = F))
# 
# mods2_c_reml <- names(delibs) %>% 
#   purrr::map(~multilevels_low_c(.x, REML = F))
# 
# mods3_c_reml <- names(delibs) %>% 
#   purrr::map(~multilevels_high_c(.x, REML = F))

# prep_reml(mods1_c_reml, bias = "no") %>% 
#   left_join(with_controls)

rbind(
  prep_dat(mods1_c, "no"),
  prep_dat(mods2_c, "low"),
  prep_dat(mods3_c, "high")
) -> with_controls

# anova(mods1_c[[1]], mods1_pol[[1]])



clean_icc_with_controls(with_controls) -> with_controls_icc

# data.frame(unique(with_controls$type))



with_controls %>% 
  janitor::clean_names() %>% 
  mutate(stars = get_p_values(p_value)) %>% 
  filter(term %nin% c("sex","income","educ", 
                      "work", "age", "sex",
                      "afro", "latino", "americas", "asian", "ESS",
                      "ethnic10", "pop10", "gdp10", "lifeexp10", 
                      "urbanratio10",
                      "(Intercept)")) %>% 
  mutate(term_cite = term) %>% 
  mutate(term = case_when(
    term == "delib10" ~ "Deliberation Component Index",
    term == "reason10" ~ "Reasoned Justification",
    term == "common10" ~ "Common Good",
    term == "countr10" ~ "Counter-Arguments",
    term == "consult10" ~ "Range of Consultation",
    term == "engage10" ~ "Engaged Society"
  )) %>% 
  mutate(term = factor(term, 
                       levels = rev(c("Deliberation Component Index",
                                           "Reasoned Justification",
                                           "Common Good",
                                           "Counter-Arguments",
                                           "Range of Consultation",
                                           "Engaged Society")))) %>% 
  mutate(model = 
           case_when(
    type == "delib10"   ~ "Models A1.1 - A1.3",
    type == "reason10"  ~ "Models B1.1 - B1.3",
    type == "common10"  ~ "Models C1.1 - C1.3",
    type == "countr10"  ~ "Models D1.1 - D1.3",
    type == "consult10" ~ "Models E1.1 - E1.3",
    type == "engage10"  ~ "Models F1.1 - F1.3"
  )) -> controls_plot

save(controls_plot, file = "data/controls_plot.Rdata")

```

### With Polity Controls


```{r}
delibs <- combined %>% select(delib10, consult10, reason10, common10, countr10, engage10)

mods1_pol <- names(delibs) %>% 
  purrr::map(progressively(multilevels_no_pol, length(delibs)))

mods2_pol <- names(delibs) %>% 
  purrr::map(progressively(multilevels_low_pol, length(delibs)))

mods3_pol <- names(delibs) %>% 
  purrr::map(progressively(multilevels_high_pol, length(delibs)))



rbind(
  prep_dat(mods1_pol, "no"),
  prep_dat(mods2_pol, "low"),
  prep_dat(mods3_pol, "high")
) -> with_pols

with_pols %>% 
  janitor::clean_names() %>% 
  mutate(stars = get_p_values(p_value)) %>% 
  filter(term %nin% c("sex","income","educ", 
                      "work", "age", "sex",
                      "afro", "latino", "americas", "asian", "ESS",
                      "ethnic10", "pop10", "gdp10", "lifeexp10", 
                      "urbanratio10",
                      "(Intercept)")) %>% 
  mutate(term_cite = term) %>%    
  mutate(term = case_when(
    term == "delib10" ~ "Deliberation Component Index",
    term == "reason10" ~ "Reasoned Justification",
    term == "common10" ~ "Common Good",
    term == "countr10" ~ "Counter-Arguments",
    term == "consult10" ~ "Range of Consultation",
    term == "engage10" ~ "Engaged Society",
    term == "polity_demdummy" & type == "delib10" ~   "Democracy (DCI)",
    term == "polity_autodummy" & type == "delib10" ~  "Autocracy (DCI)",
    term == "polity_demdummy" & type == "reason10" ~  "Democracy (RJ)",
    term == "polity_autodummy" & type == "reason10" ~ "Autocracy (RJ)",
    term == "polity_demdummy" & type == "common10" ~  "Democracy (CG)",
    term == "polity_autodummy" & type == "common10" ~ "Autocracy (CG)",
    term == "polity_demdummy" & type == "countr10" ~  "Democracy (CA)",
    term == "polity_autodummy" & type == "countr10" ~ "Autocracy (CA)",
    term == "polity_demdummy" & type == "consult10" ~  "Democracy (RoC)",
    term == "polity_autodummy" & type == "consult10" ~ "Autocracy (RoC)",
    term == "polity_demdummy" & type == "engage10" ~   "Democracy (ES)",
    term == "polity_autodummy" & type == "engage10" ~  "Autocracy (ES)"
  )) %>% 
  mutate(term = factor(term, 
                       levels = rev(c("Deliberation Component Index",
                                      "Democracy (DCI)",
                                      "Autocracy (DCI)",
                                           "Reasoned Justification",
                                      "Democracy (RJ)",
                                      "Autocracy (RJ)",
                                           "Common Good",
                                      "Democracy (CG)",
                                      "Autocracy (CG)",
                                           "Counter-Arguments",
                                      "Democracy (CA)",
                                      "Autocracy (CA)",
                                           "Range of Consultation",
                                      "Democracy (RoC)",
                                      "Autocracy (RoC)",
                                           "Engaged Society",
                                      "Democracy (ES)",
                                      "Autocracy (ES)"))))  %>% 
  mutate(model = 
           case_when(
    type == "delib10"   ~ "Models A1.4 - A1.6",
    type == "reason10"  ~ "Models B1.4 - B1.6",
    type == "common10"  ~ "Models C1.4 - C1.6",
    type == "countr10"  ~ "Models D1.4 - D1.6",
    type == "consult10" ~ "Models E1.4 - E1.6",
    type == "engage10"  ~ "Models F1.4 - F1.6"
  )) -> with_pols_dat

save(with_pols_dat, file = "data/with_pols_dat.Rdata")


clean_icc_with_pols(with_pols) -> with_pols_icc

mods3_pol %>% 
     purrr::map(vif.mer)

```



## Democracy Sample

### Null Model

```{r}
fit0_no <- lmer(gov_trust ~ 1 +
                 (1|cntry), data = combined_dem, weights = weight)

fit0_low <- lmer(gov_trust_low ~ 1 +
                 (1|cntry), data = combined_dem, weights = weight)

fit0_high <- lmer(gov_trust_high ~ 1 +
                 (1|cntry), data = combined_dem, weights = weight)

icc(fit0_no)
icc(fit0_low)
icc(fit0_high)
```


### W/O Delibs

```{r}


lmer(gov_trust ~ income + educ + 
                              work + age + sex + 
                              pop10 + gdp10 + lifeexp10 + urbanratio10 +
                              afro + latino + americas + asian + ESS +
                              (1|cntry), data = combined_dem, weights = weight) -> just_controls_dem
# delibs <- combined %>% select(delib10, consult10, reason10, common10, countr10, engage10)
# 
# 
# mods_no_dem <- names(delibs) %>% 
#   purrr::map(progressively(multilevels_no_dem, .n = length(delibs)))
# 
# mods_low_dem <- names(delibs) %>% 
#   purrr::map(progressively(multilevels_low_dem, .n = length(delibs)))
# 
# mods_high_dem <- names(delibs) %>% 
#   purrr::map(progressively(multilevels_high_dem, .n = length(delibs)))
# 
# rbind(
# mods_no_dem %>% 
#   purrr::map(broom::tidy) %>%
#   purrr::map(~create_col(., term)) %>% 
#   bind_rows() %>% 
#   mutate(bias = "no") %>% 
#   na.omit() %>% 
# left_join(mods_no_dem %>% 
#   purrr::map(p_value) %>% 
#   purrr::map(~create_col(., term)) %>% 
#   bind_rows()),
# 
# mods_low_dem %>% 
#   purrr::map(broom::tidy) %>%
#   purrr::map(~create_col(., term)) %>% 
#   bind_rows() %>% 
#   mutate(bias = "low") %>% 
#   na.omit() %>% 
# left_join(mods_low_dem %>% 
#   purrr::map(p_value) %>% 
#   purrr::map(~create_col(., term)) %>% 
#   bind_rows()),
# 
# mods_high_dem %>% 
#   purrr::map(broom::tidy) %>%
#   purrr::map(~create_col(., term)) %>% 
#   bind_rows() %>% 
#   mutate(bias = "high") %>% 
#   na.omit() %>% 
# left_join(mods_high_dem %>% 
#   purrr::map(p_value) %>% 
#   purrr::map(~create_col(., term)) %>% 
#   bind_rows())
# ) -> wo_controls_dem
# 
# 
# 
# 
# 
# 
# 
# wo_controls_dem %>% 
#   janitor::clean_names() %>% 
#   mutate(stars = get_p_values(p_value)) %>% 
#   filter(term %nin% c("sex","income","educ", 
#                            "work", "age", "sex",
#             "afro", "latino", "americas", "asian", "ESS",
#             "(Intercept)")) %>% 
#   mutate(term_cite = term) %>%    mutate(term = case_when(
#     term == "delib10" ~ "Deliberation Component Index",
#     term == "reason10" ~ "Reasoned Justification",
#     term == "common10" ~ "Common Good",
#     term == "countr10" ~ "Counter-Arguments",
#     term == "consult10" ~ "Range of Consultation",
#     term == "engage10" ~ "Engaged Society"
#   )) %>% 
#   mutate(term = factor(term, 
#                        levels = rev(c("Deliberation Component Index",
#                                            "Reasoned Justification",
#                                            "Common Good",
#                                            "Counter-Arguments",
#                                            "Range of Consultation",
#                                            "Engaged Society")))) %>% 
#  ggplot() + 
#   aes(x = term, y = estimate, color = bias) + 
#   geom_hline(yintercept = 0, 
#              color = "gray25", 
#              linetype = "dotted") + 
#   geom_linerange(aes(x = term, 
#                      ymin = estimate - std_error*interval1,
#                      ymax = estimate + std_error*interval1),
#                      lwd = 1, position = position_dodge(width = 0.7), show.legend = F) +
#   geom_pointrange(aes(x = term, 
#                       y = estimate, ymin = estimate - std_error*interval2,
#                       ymax = estimate + std_error*interval2),
#                       lwd = 1/2, position = position_dodge(width = 0.7),
#                   shape = 20, fill = "white") +
#   coord_flip() +
#   geom_text(aes(x = term, 
#                 y = estimate + 0.11,
#                 label = paste(sprintf('%.2f', estimate, 2), stars)), 
#                 position = position_dodge(width = .9),
#             show.legend = F) +
#   ggthemes::theme_hc() +
#   ggthemes::scale_colour_gdocs()
# 
# 
# ggsave(filename = "images/wo_controls_dem.png")


# plot_models(listing(mods_no, mods_low, mods_high),
#              # thatorder = anorder,
#              # col_mods = c("#24C724", "#282BD4", "#F71818"),
# #             plot_colors = c("green","green","green","green","blue","green",
# #                             "green","blue","blue","blue","blue","blue",
# #                             "red","red","red","red","red","red"),
#              exponentiate = F, std.est = "std", 
#              rm.terms = c("sex","income","educ", 
#                            "work", "age", "sex",
#             "afro", "latino", "americas", "asian", "ESS"), 
#             show.values = T, show.p = T,
#             labelv = -0.3, 
#             labelh = -0.9, 
#             labelsize = 3.2,
#             geom.size = 3, geom.spacing = 0.8, 
#             show.legend = F) + 
#             #geom.colors = palette(rainbow(18)) + 
#             theme_economist_white() + 
#             theme(legend.position = "right") 

```


### With Controls

```{r}


delibs <- combined %>% select(delib10, consult10, reason10, common10, countr10, engage10)

mods1_c_dem <- names(delibs) %>% 
  purrr::map(progressively(multilevels_no_c_dem, length(delibs)))

prep_dat(mods1_c_dem, "no") -> with_controls_dem

# anova(mods1_c[[1]], mods1_pol[[1]])



# clean_icc_with_controls(with_controls) -> with_controls_icc

# data.frame(unique(with_controls$type))


with_controls_dem %>% 
  janitor::clean_names() %>% 
  mutate(stars = get_p_values(p_value)) %>% 
  filter(term %nin% c("sex","income","educ", 
                      "work", "age", "sex",
                      "afro", "latino", "americas", "asian", "ESS",
                      "ethnic10", "pop10", "gdp10", "lifeexp10", 
                      "urbanratio10",
                      "(Intercept)")) %>% 
  mutate(term_cite = term) %>%  
  mutate(term = case_when(
    term == "delib10" ~ "Deliberation Component Index",
    term == "reason10" ~ "Reasoned Justification",
    term == "common10" ~ "Common Good",
    term == "countr10" ~ "Counter-Arguments",
    term == "consult10" ~ "Range of Consultation",
    term == "engage10" ~ "Engaged Society"
  )) %>% 
  mutate(term = factor(term, 
                       levels = rev(c("Deliberation Component Index",
                                           "Reasoned Justification",
                                           "Common Good",
                                           "Counter-Arguments",
                                           "Range of Consultation",
                                           "Engaged Society")))) %>% 
  mutate(model = 
           case_when(
    type == "delib10"   ~ "Models A2.1",
    type == "reason10"  ~ "Models B2.1",
    type == "common10"  ~ "Models C2.1",
    type == "countr10"  ~ "Models D2.1",
    type == "consult10" ~ "Models E2.1",
    type == "engage10"  ~ "Models F2.1"
  )) -> controls_plot_dem

save(controls_plot_dem, file = "data/controls_plot_dem.Rdata")



```


### With Polity Controls

```{r}
delibs <- combined %>% select(delib10, consult10, reason10, common10, countr10, engage10)

mods1_pol_dem <- names(delibs) %>% 
  purrr::map(progressively(multilevels_no_pol_dem, length(delibs)))



rbind(
  prep_dat(mods1_pol_dem, "no")
) -> with_pols_dem

with_pols_dem %>% 
  janitor::clean_names() %>% 
  mutate(stars = get_p_values(p_value)) %>% 
  filter(term %nin% c("sex","income","educ", 
                      "work", "age", "sex",
                      "afro", "latino", "americas", "asian", "ESS",
                      "ethnic10", "pop10", "gdp10", "lifeexp10", 
                      "urbanratio10",
                      "(Intercept)")) %>% 
  mutate(term_cite = term) %>%    
  mutate(term = case_when(
    term == "delib10" ~ "Deliberation Component Index",
    term == "reason10" ~ "Reasoned Justification",
    term == "common10" ~ "Common Good",
    term == "countr10" ~ "Counter-Arguments",
    term == "consult10" ~ "Range of Consultation",
    term == "engage10" ~ "Engaged Society",
    term == "polity10" & type == "delib10" ~   "Democracy (DCI)",
    term == "polity10" & type == "reason10" ~  "Democracy (RJ)",
    term == "polity10" & type == "common10" ~  "Democracy (CG)",
    term == "polity10" & type == "countr10" ~  "Democracy (CA)",
    term == "polity10" & type == "consult10" ~  "Democracy (RoC)",
    term == "polity10" & type == "engage10" ~   "Democracy (ES)"
  )) %>% 
  mutate(term = factor(term, 
                       levels = rev(c("Deliberation Component Index",
                                      "Democracy (DCI)",
                                           "Reasoned Justification",
                                      "Democracy (RJ)",
                                           "Common Good",
                                      "Democracy (CG)",
                                           "Counter-Arguments",
                                      "Democracy (CA)",
                                           "Range of Consultation",
                                      "Democracy (RoC)",
                                           "Engaged Society",
                                      "Democracy (ES)"))))  %>% 
  mutate(model = 
           case_when(
    type == "delib10"   ~ "Models A2.2",
    type == "reason10"  ~ "Models B2.2",
    type == "common10"  ~ "Models C2.2",
    type == "countr10"  ~ "Models D2.2",
    type == "consult10" ~ "Models E2.2",
    type == "engage10"  ~ "Models F2.2"
  )) -> with_pols_dat_dem



save(with_pols_dat_dem, file = "data/with_pols_dat_dem.Rdata")


# clean_icc_with_pols(with_pols) -> with_pols_icc

with_pols_dat_dem %>% 
  filter(term %in% c("Democracy (DCI)",
                     "Democracy (RJ)",
                     "Democracy (CG)",
                     "Democracy (CA)",
                     "Democracy (RoC)",
                     "Democracy (ES)")) -> with_pols_dat_regime_dem

with_pols_dat_dem %>% 
  filter(term %nin% c("Democracy (DCI)",
                     "Democracy (RJ)",
                     "Democracy (CG)",
                     "Democracy (CA)",
                     "Democracy (RoC)",
                     "Democracy (ES)")) -> with_pols_dat_delibs_dem

# library(scales)
# show_col(gdocs_pal()(3))

mods1_pol_dem %>% 
     purrr::map(vif.mer)
```



## Non-Democracy Sample

### Null Model

```{r}
fit0_no <- lmer(gov_trust ~ 1 +
                 (1|cntry), data = combined_nondem, weights = weight)

fit0_low <- lmer(gov_trust_low ~ 1 +
                 (1|cntry), data = combined_nondem, weights = weight)

fit0_high <- lmer(gov_trust_high ~ 1 +
                 (1|cntry), data = combined_nondem, weights = weight)

icc(fit0_no)
icc(fit0_low)
icc(fit0_high)
```


### W/O Delibs

```{r}

list(
lmer(gov_trust ~ income + educ + 
                              work + age + sex + 
                              pop10 + gdp10 + lifeexp10 + urbanratio10 +
                              afro + latino + americas + asian + ESS +
                              (1|cntry), data = combined_nondem, weights = weight),

lmer(gov_trust_low ~ income + educ + 
                              work + age + sex + 
                              pop10 + gdp10 + lifeexp10 + urbanratio10 +
                              afro + latino + americas + asian + ESS +
                              (1|cntry), data = combined_nondem, weights = weight),

lmer(gov_trust_high ~ income + educ + 
                              work + age + sex + 
                              pop10 + gdp10 + lifeexp10 + urbanratio10 +
                              afro + latino + americas + asian + ESS +
                              (1|cntry), data = combined_nondem, weights = weight)
) -> just_controls_nondem

# delibs <- combined %>% select(delib10, consult10, reason10, common10, countr10, engage10)
# 
# 
# mods_no_nondem <- names(delibs) %>% 
#   purrr::map(progressively(multilevels_no_nondem, .n = length(delibs)))
# 
# mods_low_nondem <- names(delibs) %>% 
#   purrr::map(progressively(multilevels_low_nondem, .n = length(delibs)))
# 
# mods_high_nondem <- names(delibs) %>% 
#   purrr::map(progressively(multilevels_high_nondem, .n = length(delibs)))
# 
# rbind(
# mods_no_nondem %>% 
#   purrr::map(broom::tidy) %>%
#   purrr::map(~create_col(., term)) %>% 
#   bind_rows() %>% 
#   mutate(bias = "no") %>% 
#   na.omit() %>% 
# left_join(mods_no_nondem %>% 
#   purrr::map(p_value) %>% 
#   purrr::map(~create_col(., term)) %>% 
#   bind_rows()),
# 
# mods_low_nondem %>% 
#   purrr::map(broom::tidy) %>%
#   purrr::map(~create_col(., term)) %>% 
#   bind_rows() %>% 
#   mutate(bias = "low") %>% 
#   na.omit() %>% 
# left_join(mods_low_nondem %>% 
#   purrr::map(p_value) %>% 
#   purrr::map(~create_col(., term)) %>% 
#   bind_rows()),
# 
# mods_high_nondem %>% 
#   purrr::map(broom::tidy) %>%
#   purrr::map(~create_col(., term)) %>% 
#   bind_rows() %>% 
#   mutate(bias = "high") %>% 
#   na.omit() %>% 
# left_join(mods_high_nondem %>% 
#   purrr::map(p_value) %>% 
#   purrr::map(~create_col(., term)) %>% 
#   bind_rows())
# ) -> wo_controls_nondem
# 
# 
# 
# 
# 
# 
# 
# wo_controls_nondem %>% 
#   janitor::clean_names() %>% 
#   mutate(stars = get_p_values(p_value)) %>% 
#   filter(term %nin% c("sex","income","educ", 
#                            "work", "age", "sex",
#             "afro", "latino", "americas", "asian", "ESS",
#             "(Intercept)")) %>% 
#   mutate(term_cite = term) %>%    mutate(term = case_when(
#     term == "delib10" ~ "Deliberation Component Index",
#     term == "reason10" ~ "Reasoned Justification",
#     term == "common10" ~ "Common Good",
#     term == "countr10" ~ "Counter-Arguments",
#     term == "consult10" ~ "Range of Consultation",
#     term == "engage10" ~ "Engaged Society"
#   )) %>% 
#   mutate(term = factor(term, 
#                        levels = rev(c("Deliberation Component Index",
#                                            "Reasoned Justification",
#                                            "Common Good",
#                                            "Counter-Arguments",
#                                            "Range of Consultation",
#                                            "Engaged Society")))) %>% 
#  ggplot() + 
#   aes(x = term, y = estimate, color = bias) + 
#   geom_hline(yintercept = 0, 
#              color = "gray25", 
#              linetype = "dotted") + 
#   geom_linerange(aes(x = term, 
#                      ymin = estimate - std_error*interval1,
#                      ymax = estimate + std_error*interval1),
#                      lwd = 1, position = position_dodge(width = 0.7), show.legend = F) +
#   geom_pointrange(aes(x = term, 
#                       y = estimate, ymin = estimate - std_error*interval2,
#                       ymax = estimate + std_error*interval2),
#                       lwd = 1/2, position = position_dodge(width = 0.7),
#                   shape = 20, fill = "white") +
#   coord_flip() +
#   geom_text(aes(x = term, 
#                 y = estimate + 0.11,
#                 label = paste(sprintf('%.2f', estimate, 2), stars)), 
#                 position = position_dodge(width = .9),
#             show.legend = F) +
#   ggthemes::theme_hc() +
#   ggthemes::scale_colour_gdocs()
# 
# 
# ggsave(filename = "images/wo_controls_nondem.png")
# 

# plot_models(listing(mods_no, mods_low, mods_high),
#              # thatorder = anorder,
#              # col_mods = c("#24C724", "#282BD4", "#F71818"),
# #             plot_colors = c("green","green","green","green","blue","green",
# #                             "green","blue","blue","blue","blue","blue",
# #                             "red","red","red","red","red","red"),
#              exponentiate = F, std.est = "std", 
#              rm.terms = c("sex","income","educ", 
#                            "work", "age", "sex",
#             "afro", "latino", "americas", "asian", "ESS"), 
#             show.values = T, show.p = T,
#             labelv = -0.3, 
#             labelh = -0.9, 
#             labelsize = 3.2,
#             geom.size = 3, geom.spacing = 0.8, 
#             show.legend = F) + 
#             #geom.colors = palette(rainbow(18)) + 
#             theme_economist_white() + 
#             theme(legend.position = "right") 

```


### With Controls

```{r}



delibs <- combined %>% select(delib10, consult10, reason10, common10, countr10, engage10)

mods1_c_nondem <- names(delibs) %>% 
  purrr::map(progressively(multilevels_no_c_nondem, length(delibs)))

mods2_c_nondem <- names(delibs) %>% 
  purrr::map(progressively(multilevels_low_c_nondem, length(delibs)))

mods3_c_nondem <- names(delibs) %>% 
  purrr::map(progressively(multilevels_high_c_nondem, length(delibs)))

rbind(prep_dat(mods1_c_nondem, "no"),
prep_dat(mods2_c_nondem, "low"),
prep_dat(mods3_c_nondem, "high")) -> with_controls_nondem

# anova(mods1_c[[1]], mods1_pol[[1]])



# clean_icc_with_controls(with_controls) -> with_controls_icc

# data.frame(unique(with_controls$type))


with_controls_nondem %>% 
  janitor::clean_names() %>% 
  mutate(stars = get_p_values(p_value)) %>% 
  filter(term %nin% c("sex","income","educ", 
                      "work", "age", "sex",
                      "afro", "latino", "americas", "asian", "ESS",
                      "ethnic10", "pop10", "gdp10", "lifeexp10", 
                      "urbanratio10",
                      "(Intercept)")) %>% 
  mutate(term_cite = term) %>%    
  mutate(term = case_when(
    term == "delib10" ~ "Deliberation Component Index",
    term == "reason10" ~ "Reasoned Justification",
    term == "common10" ~ "Common Good",
    term == "countr10" ~ "Counter-Arguments",
    term == "consult10" ~ "Range of Consultation",
    term == "engage10" ~ "Engaged Society"
  )) %>% 
  mutate(term = factor(term, 
                       levels = rev(c("Deliberation Component Index",
                                           "Reasoned Justification",
                                           "Common Good",
                                           "Counter-Arguments",
                                           "Range of Consultation",
                                           "Engaged Society")))) %>% 
  mutate(model = 
           case_when(
    type == "delib10"   ~ "Models A3.1 - A3.3",
    type == "reason10"  ~ "Models B3.1 - B3.3",
    type == "common10"  ~ "Models C3.1 - C3.3",
    type == "countr10"  ~ "Models D3.1 - D3.3",
    type == "consult10" ~ "Models E3.1 - E3.3",
    type == "engage10"  ~ "Models F3.1 - F3.3"
  )) -> controls_plot_nondem

save(controls_plot_nondem, file = "data/controls_plot_nondem.Rdata")





```


### With Polity Controls

```{r}
delibs <- combined %>% select(delib10, consult10, reason10, common10, countr10, engage10)

mods1_pol_nondem <- names(delibs) %>% 
  purrr::map(progressively(multilevels_no_pol_nondem, length(delibs)))

mods2_pol_nondem <- names(delibs) %>% 
  purrr::map(progressively(multilevels_low_pol_nondem, length(delibs)))

mods3_pol_nondem <- names(delibs) %>% 
  purrr::map(progressively(multilevels_high_pol_nondem, length(delibs)))


rbind(
  prep_dat(mods1_pol_nondem, "no"),
  prep_dat(mods2_pol_nondem, "low"),
  prep_dat(mods3_pol_nondem, "high")
) -> with_pols_nondem

with_pols_nondem %>% 
  janitor::clean_names() %>% 
  mutate(stars = get_p_values(p_value)) %>% 
  filter(term %nin% c("sex","income","educ", 
                      "work", "age", "sex",
                      "afro", "latino", "americas", "asian", "ESS",
                      "ethnic10", "pop10", "gdp10", "lifeexp10", 
                      "urbanratio10",
                      "(Intercept)")) %>% 
  mutate(term_cite = term) %>%  
  mutate(term = case_when(
    term == "delib10" ~ "Deliberation Component Index",
    term == "reason10" ~ "Reasoned Justification",
    term == "common10" ~ "Common Good",
    term == "countr10" ~ "Counter-Arguments",
    term == "consult10" ~ "Range of Consultation",
    term == "engage10" ~ "Engaged Society",
    term == "polity10" & type == "delib10" ~   "Democracy (DCI)",
    term == "polity10" & type == "reason10" ~  "Democracy (RJ)",
    term == "polity10" & type == "common10" ~  "Democracy (CG)",
    term == "polity10" & type == "countr10" ~  "Democracy (CA)",
    term == "polity10" & type == "consult10" ~  "Democracy (RoC)",
    term == "polity10" & type == "engage10" ~   "Democracy (ES)"
  )) %>% 
  mutate(term = factor(term, 
                       levels = rev(c("Deliberation Component Index",
                                      "Democracy (DCI)",
                                           "Reasoned Justification",
                                      "Democracy (RJ)",
                                           "Common Good",
                                      "Democracy (CG)",
                                           "Counter-Arguments",
                                      "Democracy (CA)",
                                           "Range of Consultation",
                                      "Democracy (RoC)",
                                           "Engaged Society",
                                      "Democracy (ES)"))))  %>% 
  mutate(model = 
           case_when(
    type == "delib10"   ~ "Models A3.4 - A3.6",
    type == "reason10"  ~ "Models B3.4 - B3.6",
    type == "common10"  ~ "Models C3.4 - C3.6",
    type == "countr10"  ~ "Models D3.4 - D3.6",
    type == "consult10" ~ "Models E3.4 - E3.6",
    type == "engage10"  ~ "Models F3.4 - F3.6"
  )) -> with_pols_dat_nondem

save(with_pols_dat_nondem, file = "data/with_pols_dat_nondem.Rdata")


rbind(
1:6 %>% 
  purrr::map(~get_anovies(mods1_c_nondem, mods1_pol_nondem, .x)) %>% 
  bind_rows() %>% 
  mutate(bias = "no") %>% 
  mutate(type = c("delib10", "consult10", "reason10", 
                  "common10", "countr10", "engage10")),
1:6 %>% 
  purrr::map(~get_anovies(mods2_c_nondem, mods2_pol_nondem, .x)) %>% 
  bind_rows() %>% 
  mutate(bias = "low") %>% 
  mutate(type = c("delib10", "consult10", "reason10", 
                  "common10", "countr10", "engage10")),
1:6 %>% 
  purrr::map(~get_anovies(mods3_c_nondem, mods3_pol_nondem, .x)) %>% 
  bind_rows() %>% 
  mutate(bias = "high") %>% 
  mutate(type = c("delib10", "consult10", "reason10", 
                  "common10", "countr10", "engage10"))
)  -> anovies_pols_original_nondem




mods3_pol_nondem %>% 
     purrr::map(vif.mer)



```



### Tables

```{r}
library(texreg)

# anorder <- c("delib10", "reason10", "common10", "countr10", "consult10", "engage10")
# delibs <- combined %>% select(delib10, consult10, reason10, common10, countr10, engage10)

screenreg(list(mods1_pol_nondem, mods2_pol_nondem, mods3_pol_nondem) %>% unlist,
          label = "mods1_pol_nondem",
          caption = "Bolded coefficients, custom notes, three digits.",
          float.pos = "h", bold = 0.05, stars = 0,
          custom.note = "Coefficients with $p < 0.05$ in \\textbf{bold}.",
          digits = 2, leading.zero = FALSE)

# 
# texreg(list(mods1_pol_nondem[[1]], mods2_pol_nondem[[1]], mods3_pol_nondem[[1]],
#                mods1_pol_nondem[[3]], mods2_pol_nondem[[3]], mods3_pol_nondem[[3]],
#                mods1_pol_nondem[[4]], mods2_pol_nondem[[4]], mods3_pol_nondem[[4]],
#                mods1_pol_nondem[[5]], mods2_pol_nondem[[5]], mods3_pol_nondem[[5]],
#                mods1_pol_nondem[[2]], mods2_pol_nondem[[2]], mods3_pol_nondem[[2]],
#                mods1_pol_nondem[[6]], mods2_pol_nondem[[6]], mods3_pol_nondem[[6]]) %>% unlist,
#           label = "mods1_pol_nondem",
#           caption = "Bolded coefficients, custom notes, three digits.",
#           float.pos = "h", bold = 0.10, 
#           custom.note = "Coefficients with $p < 0.05$ in \\textbf{bold}.",
#           digits = 2, leading.zero = FALSE, stars = c(0.001, 0.01, 0.05, 0.1),
#           symbol = "^\\dagger", reorder.coef = c(1:6, 9:13, 8, 14:18, 7, 19:23),
#           groups = list("\\textbf{Individual-Level Control Variables}" = 2:6, 
#                         "\\textbf{Country-Level Control Variables}" = 7:11,
#                         "\\textbf{Dataset Control Dummies}" = 12:16,
#                         "\\textbf{DCI \\& Subcomponents}" = 17:23), 
#           custom.coef.names =  c("Intercept",
#                                  "Financial Security",
#                                  "Education",
#                                  "Employment (0/1)",
#                                  "Age",
#                                  "Sex (Male/Female)",
#                                  "logged Population",
#                                  "logged GDP per capita",
#                                  "Life Expectancy",
#                                  "Corruption",
#                                  "Urban Pop. Ratio",
#                                  "Polity/FH",
#                                  "Afrobarometer (0/1)",
#                                  "Latinobarometro (0/1)",
#                                  "Americasbarometer (0/1)",
#                                  "Asianbarometer (0/1)",
#                                  "ESS (0/1)",
#                                  "DCI",
#                                  "Reasoned Justification",
#                                  "Common Good",
#                                  "Counter-Arguments",
#                                  "Range of Consultation",
#                                  "Engaged Society"))



# screenreg(mods1_pol_nondem[[1]] ,reorder.coef = c(1:6, 9:13, 8, 14:18, 7)), 
#           custom.coef.names =  c("Intercept",
#                                  "Education",
#                                  "Employment (0/1)",
#                                  "Age",
#                                  "Sex (Male/Female)",
#                                  "logged Population",
#                                  "logged GDP per capita",
#                                  "Life Expectancy",
#                                  "Corruption",
#                                  "Urban Pop. Ratio",
#                                  "Polity/FH",
#                                  "Afrobarometer (0/1)",
#                                  "Latinobarometro (0/1)",
#                                  "Americasbarometer (0/1)",
#                                  "Asianbarometer (0/1)",
#                                  "ESS (0/1)",
#                                  "DCI"))
```



# oNly Polity

## complete sample

```{r}
list(
lmer(gov_trust ~ income + educ + 
                              work + age + sex + polity_demdummy + polity_autodummy +
                              pop10 + gdp10 + lifeexp10 + urbanratio10 +
                              afro + latino + americas + asian + ESS +
                              (1|cntry), data = combined, weights = weight),

lmer(gov_trust_low ~ income + educ + 
                              work + age + sex + polity_demdummy + polity_autodummy +
                              pop10 + gdp10 + lifeexp10 + urbanratio10 +
                              afro + latino + americas + asian + ESS +
                              (1|cntry), data = combined, weights = weight),

lmer(gov_trust_high ~ income + educ + 
                              work + age + sex + polity_demdummy + polity_autodummy +
                              pop10 + gdp10 + lifeexp10 + urbanratio10 +
                              afro + latino + americas + asian + ESS +
                              (1|cntry), data = combined, weights = weight)
) -> polity_complete



polity_complete %>% 
   purrr::map(broom::tidy) %>% 
   bind_rows() %>% 
    left_join(polity_complete %>% 
                purrr::map(p_value) %>% 
                bind_rows()) %>% 
  mutate(bias = c(rep("no", 19), rep("low", 19), rep("high", 19))) %>% 
  na.omit() -> just_pols


just_pols %>% 
  janitor::clean_names() %>% 
  mutate(stars = get_p_values(p_value)) %>% 
  filter(term %nin% c("sex","income","educ", 
                      "work", "age", "sex",
                      "afro", "latino", "americas", "asian", "ESS",
                      "ethnic10", "pop10", "gdp10", "lifeexp10", 
                      "urbanratio10",
                      "(Intercept)")) %>% 
  mutate(term_cite = term) %>%    
  mutate(term = case_when(
    term == "polity_demdummy" ~   "Democracy (0/1)",
    term == "polity_autodummy" ~  "Autocracy (0/1)"
  )) %>% 
  mutate(term = factor(term, 
                       levels = rev(c("Democracy (0/1)",
                                      "Autocracy (0/1)"))))  %>% 
  mutate(model =  "Models P1.1 - P1.3") -> just_pols_dat

save(just_pols_dat, file = "data/just_pols_dat.Rdata")




```

## demsample

```{r}
lmer(gov_trust ~ income + educ + 
                              work + age + sex + polity10 +
                              pop10 + gdp10 + lifeexp10 + urbanratio10 +
                              afro + latino + americas + asian + ESS +
                              (1|cntry), data = combined_dem, weights = weight) -> polity_dem


polity_dem %>% 
   broom::tidy() %>% 
    left_join(polity_dem %>% 
                p_value()) %>% 
  mutate(bias = "no") %>% 
  na.omit() -> just_pols_dem



just_pols_dem %>% 
  janitor::clean_names() %>% 
  mutate(stars = get_p_values(p_value)) %>% 
  filter(term %nin% c("sex","income","educ", 
                      "work", "age", "sex",
                      "afro", "latino", "americas", "asian", "ESS",
                      "ethnic10", "pop10", "gdp10", "lifeexp10", 
                      "urbanratio10",
                      "(Intercept)")) %>% 
  mutate(term_cite = term) %>%   
  mutate(term = case_when(
    term == "polity10" ~   "Polity/FH"
  )) %>% 
  mutate(model =  "Models P2.1") -> just_pols_dat_dem

save(just_pols_dat_dem, file = "data/just_pols_dat_dem.Rdata")


```

## nondemsample

```{r}
list(
lmer(gov_trust ~ income + educ + 
                              work + age + sex + polity10 +
                              pop10 + gdp10 + lifeexp10 + urbanratio10 +
                              afro + latino + americas + asian + ESS +
                              (1|cntry), data = combined_nondem, weights = weight),

lmer(gov_trust_low ~ income + educ + 
                              work + age + sex + polity10 +
                              pop10 + gdp10 + lifeexp10 + urbanratio10 +
                              afro + latino + americas + asian + ESS +
                              (1|cntry), data = combined_nondem, weights = weight),

lmer(gov_trust_high ~ income + educ + 
                              work + age + sex + polity10 +
                              pop10 + gdp10 + lifeexp10 + urbanratio10 +
                              afro + latino + americas + asian + ESS +
                              (1|cntry), data = combined_nondem, weights = weight)
) -> polity_nondem



polity_nondem %>% 
   purrr::map(broom::tidy) %>% 
   bind_rows() %>% 
    left_join(polity_nondem %>% 
                purrr::map(p_value) %>% 
                bind_rows()) %>% 
  mutate(bias = c(rep("no", 18), rep("low", 18), rep("high", 18))) %>% 
  na.omit() -> just_pols_nondem



just_pols_nondem %>% 
  janitor::clean_names() %>% 
  mutate(stars = get_p_values(p_value)) %>% 
  filter(term %nin% c("sex","income","educ", 
                      "work", "age", "sex",
                      "afro", "latino", "americas", "asian", "ESS",
                      "ethnic10", "pop10", "gdp10", "lifeexp10", 
                      "urbanratio10",
                      "(Intercept)")) %>% 
  mutate(term_cite = term) %>%   
  mutate(term = case_when(
    term == "polity10" ~   "Polity/FH"
  )) %>% 
  mutate(model =  "Models P3.1 - Models P3.3") -> just_pols_dat_nondem

save(just_pols_dat_nondem, file = "data/just_pols_dat_nondem.Rdata")



```


# save all models

```{r}

class(polity_dem)

invisible({
  sapply(ls(envir = .GlobalEnv), function(x) {
    obj <- get(x, envir = .GlobalEnv)
    if (class(obj) == "list") {
      save(obj, file = paste0("data/mods/", x, ".Rdata"))
    }
  })
})

invisible({
  sapply(ls(envir = .GlobalEnv), function(x) {
    obj <- get(x, envir = .GlobalEnv)
    if (class(obj) == "lmerMod") {
      save(obj, file = paste0("data/mods/", x, ".Rdata"))
    }
  })
})
```


# anovie prepare

## w/o delibs

```{r}

rbind(
1:6 %>% 
  purrr::map(~get_anovies_pol(mods1_c, just_controls[[1]], .x)) %>% 
  bind_rows() %>% 
  mutate(bias = "no") %>% 
  mutate(type = c("delib10", "consult10", "reason10", "common10", "countr10", "engage10")),

1:6 %>% 
  purrr::map(~get_anovies_pol(mods2_c, just_controls[[2]], .x)) %>% 
  bind_rows() %>% 
  mutate(bias = "low") %>% 
  mutate(type = c("delib10", "consult10", "reason10", "common10", "countr10", "engage10")),

1:6 %>% 
  purrr::map(~get_anovies_pol(mods3_c, just_controls[[3]], .x)) %>% 
  bind_rows() %>% 
  mutate(bias = "high") %>% 
  mutate(type = c("delib10", "consult10", "reason10", "common10", "countr10", "engage10"))

) -> anovies_wo_delibs

1:6 %>%
  purrr::map(~get_anovies_pol(mods1_c_dem, just_controls_dem, .x)) %>%
  bind_rows() %>%
  mutate(bias = "no") %>%
  mutate(type = c("delib10", "consult10", "reason10", 
                  "common10", "countr10", "engage10")) -> anovies_wo_delibs_dem


rbind(
1:6 %>%
  purrr::map(~get_anovies_pol(mods1_c_nondem, just_controls_nondem[[1]], .x)) %>%
  bind_rows() %>%
  mutate(bias = "no") %>%
  mutate(type = c("delib10", "consult10", "reason10", 
                  "common10", "countr10", "engage10")),
1:6 %>%
  purrr::map(~get_anovies_pol(mods2_c_nondem, just_controls_nondem[[2]], .x)) %>%
  bind_rows() %>%
  mutate(bias = "low") %>%
  mutate(type = c("delib10", "consult10", "reason10", 
                  "common10", "countr10", "engage10")), 

1:6 %>%
  purrr::map(~get_anovies_pol(mods3_c_nondem, just_controls_nondem[[3]], .x)) %>%
  bind_rows() %>%
  mutate(bias = "high") %>%
  mutate(type = c("delib10", "consult10", "reason10", 
                  "common10", "countr10", "engage10"))

) -> anovies_wo_delibs_nondem

rbind(anovies_wo_delibs %>% 
        mutate(comparison = "Just Control Models vs. Just Deliberation Models (Complete Sample)"),
      anovies_wo_delibs_dem %>% 
        mutate(comparison = "Just Control Models vs. Just Deliberation Models (Dem. Sample)"),
      anovies_wo_delibs_nondem %>% 
        mutate(comparison = "Just Control Models vs. Just Deliberation Models (Non-Dem. Sample)")) -> full_anovies_wo_delibs

full_anovies_wo_delibs %<>% 
 mutate(stars = ifelse(stars == "", "-", stars)) %>% 
 mutate(stars = case_when(
   stars == "^" ~ "p < 0.10", 
   stars == "*" ~ "p < 0.05", 
   stars == "**" ~ "p < 0.01", 
   stars == "***" ~ "p < 0.001", 
   stars == "-" ~ "n.s."
 )) %>% 
 mutate(stars = factor(stars, levels = c("n.s.", "p < 0.10", "p < 0.05", 
                                         "p < 0.01", "p < 0.001"))) %>% 
 mutate(report =  paste0("chi^2*", report)) %>% 
 mutate(bias = case_when(
   bias == "no" ~ "No Bias",
   bias == "low" ~ "Low Bias",
   bias == "high" ~ "High Bias")) %>% 
 mutate(bias = factor(bias, levels = c("No Bias", "Low Bias", "High Bias"))) %>% 
 mutate(type = case_when(
    type == "delib10" ~ "Deliberation Component Index",
    type == "reason10" ~ "Reasoned Justification",
    type == "common10" ~ "Common Good",
    type == "countr10" ~ "Counter-Arguments",
    type == "consult10" ~ "Range of Consultation",
    type == "engage10" ~ "Engaged Society"
  )) %>% 
  mutate(type = factor(type, levels = rev(c("Deliberation Component Index",
                                           "Reasoned Justification",
                                           "Common Good",
                                           "Counter-Arguments",
                                           "Range of Consultation",
                                           "Engaged Society")))) 

save(full_anovies_wo_delibs, file = "data/full_anovies_wo_delibs.Rdata")



```


## complete sample

```{r}

rbind(
1:6 %>% 
  purrr::map(~get_anovies(mods1_c, mods1_pol, .x)) %>% 
  bind_rows() %>% 
  mutate(bias = "no") %>% 
  mutate(type = c("delib10", "consult10", "reason10", "common10", "countr10", "engage10")),
1:6 %>% 
  purrr::map(~get_anovies(mods2_c, mods2_pol, .x)) %>% 
  bind_rows() %>% 
  mutate(bias = "low") %>% 
  mutate(type = c("delib10", "consult10", "reason10", "common10", "countr10", "engage10")),
1:6 %>% 
  purrr::map(~get_anovies(mods3_c, mods3_pol, .x)) %>% 
  bind_rows() %>% 
  mutate(bias = "high") %>% 
  mutate(type = c("delib10", "consult10", "reason10", "common10", "countr10", "engage10"))
)  -> anovies_delibs


rbind(
1:6 %>% 
  purrr::map(~get_anovies_pol(mods1_pol, polity_complete[[1]], .x)) %>% 
  bind_rows() %>% 
  mutate(bias = "no") %>% 
  mutate(type = c("delib10", "consult10", "reason10", "common10", "countr10", "engage10")),

1:6 %>% 
  purrr::map(~get_anovies_pol(mods2_pol, polity_complete[[2]], .x)) %>% 
  bind_rows() %>% 
  mutate(bias = "low") %>% 
  mutate(type = c("delib10", "consult10", "reason10", "common10", "countr10", "engage10")),

1:6 %>% 
  purrr::map(~get_anovies_pol(mods3_pol, polity_complete[[3]], .x)) %>% 
  bind_rows() %>% 
  mutate(bias = "high") %>% 
  mutate(type = c("delib10", "consult10", "reason10", "common10", "countr10", "engage10"))

) -> anovies_pols

rbind(anovies_pols %>% 
        mutate(comparison = "Just Polity/FH Models vs. Complete Models"),
      anovies_delibs %>% 
        mutate(comparison = "Just Deliberation Models vs. Complete Models")) -> full_anovies

full_anovies %<>% 
 mutate(stars = ifelse(stars == "", "-", stars)) %>% 
 mutate(stars = case_when(
   stars == "^" ~ "p < 0.10", 
   stars == "*" ~ "p < 0.05", 
   stars == "**" ~ "p < 0.01", 
   stars == "***" ~ "p < 0.001", 
   stars == "-" ~ "n.s."
 )) %>% 
 mutate(stars = factor(stars, levels = c("n.s.", "p < 0.10", "p < 0.05", 
                                         "p < 0.01", "p < 0.001"))) %>% 
 mutate(report =  paste0("chi^2*", report)) %>% 
 mutate(bias = case_when(
   bias == "no" ~ "No Bias",
   bias == "low" ~ "Low Bias",
   bias == "high" ~ "High Bias")) %>% 
 mutate(bias = factor(bias, levels = c("No Bias", "Low Bias", "High Bias"))) %>% 
 mutate(type = case_when(
    type == "delib10" ~ "Deliberation Component Index",
    type == "reason10" ~ "Reasoned Justification",
    type == "common10" ~ "Common Good",
    type == "countr10" ~ "Counter-Arguments",
    type == "consult10" ~ "Range of Consultation",
    type == "engage10" ~ "Engaged Society"
  )) %>% 
  mutate(type = factor(type, levels = rev(c("Deliberation Component Index",
                                           "Reasoned Justification",
                                           "Common Good",
                                           "Counter-Arguments",
                                           "Range of Consultation",
                                           "Engaged Society")))) 

save(full_anovies, file = "data/full_anovies.Rdata")



```

## demsample

```{r}
# rm(mods1_c, mods2_c, mods3_c)

1:6 %>% 
  purrr::map(~get_anovies(mods1_c_dem, mods1_pol_dem, .x)) %>% 
  bind_rows() %>% 
  mutate(bias = "no") %>% 
  mutate(type = c("delib10", "consult10", "reason10", 
                  "common10", "countr10", "engage10"))  -> anovies_delibs_dem


1:6 %>%
  purrr::map(~get_anovies_pol(mods1_pol_dem, polity_dem, .x)) %>%
  bind_rows() %>%
  mutate(bias = "no") %>%
  mutate(type = c("delib10", "consult10", "reason10", 
                  "common10", "countr10", "engage10")) -> anovies_pols_dem

rbind(anovies_pols_dem %>% 
        mutate(comparison = "Just Polity/FH Models vs. Complete Models"),
      anovies_delibs_dem %>% 
        mutate(comparison = "Just Deliberation Models vs. Complete Models")) -> full_anovies_dem

full_anovies_dem %<>% 
 mutate(stars = ifelse(stars == "", "-", stars)) %>% 
 mutate(stars = case_when(
   stars == "^" ~ "p < 0.10", 
   stars == "*" ~ "p < 0.05", 
   stars == "**" ~ "p < 0.01", 
   stars == "***" ~ "p < 0.001", 
   stars == "-" ~ "n.s."
 )) %>% 
 mutate(stars = factor(stars, levels = c("n.s.", "p < 0.10", "p < 0.05", 
                                         "p < 0.01", "p < 0.001"))) %>% 
 mutate(report =  paste0("chi^2*", report)) %>% 
 mutate(bias = case_when(
   bias == "no" ~ "No Bias",
   bias == "low" ~ "Low Bias",
   bias == "high" ~ "High Bias")) %>% 
 mutate(bias = factor(bias, levels = c("No Bias", "Low Bias", "High Bias"))) %>% 
 mutate(type = case_when(
    type == "delib10" ~ "Deliberation Component Index",
    type == "reason10" ~ "Reasoned Justification",
    type == "common10" ~ "Common Good",
    type == "countr10" ~ "Counter-Arguments",
    type == "consult10" ~ "Range of Consultation",
    type == "engage10" ~ "Engaged Society"
  )) %>% 
  mutate(type = factor(type, levels = rev(c("Deliberation Component Index",
                                           "Reasoned Justification",
                                           "Common Good",
                                           "Counter-Arguments",
                                           "Range of Consultation",
                                           "Engaged Society")))) 

save(full_anovies_dem, file = "data/full_anovies_dem.Rdata")





```

## nondemsample

```{r}
# rm(mods1_c_dem, mods1_pol_dem, mods1_pol)

rbind(
1:6 %>% 
  purrr::map(~get_anovies(mods1_c_nondem, mods1_pol_nondem , .x)) %>% 
  bind_rows() %>% 
  mutate(bias = "no") %>% 
  mutate(type = c("delib10", "consult10", "reason10", 
                  "common10", "countr10", "engage10")),  

1:6 %>% 
  purrr::map(~get_anovies(mods2_c_nondem, mods2_pol_nondem, .x)) %>% 
  bind_rows() %>% 
  mutate(bias = "low") %>% 
  mutate(type = c("delib10", "consult10", "reason10", 
                  "common10", "countr10", "engage10")),  

1:6 %>% 
  purrr::map(~get_anovies(mods3_c_nondem, mods3_pol_nondem, .x)) %>% 
  bind_rows() %>% 
  mutate(bias = "high") %>% 
  mutate(type = c("delib10", "consult10", "reason10", 
                  "common10", "countr10", "engage10"))  

) -> anovies_delibs_nondem

rbind(
1:6 %>%
  purrr::map(~get_anovies_pol(mods1_pol_nondem, polity_nondem[[1]], .x)) %>%
  bind_rows() %>%
  mutate(bias = "no") %>%
  mutate(type = c("delib10", "consult10", "reason10", 
                  "common10", "countr10", "engage10")),
1:6 %>%
  purrr::map(~get_anovies_pol(mods2_pol_nondem, polity_nondem[[2]], .x)) %>%
  bind_rows() %>%
  mutate(bias = "low") %>%
  mutate(type = c("delib10", "consult10", "reason10", 
                  "common10", "countr10", "engage10")), 

1:6 %>%
  purrr::map(~get_anovies_pol(mods3_pol_nondem, polity_nondem[[3]], .x)) %>%
  bind_rows() %>%
  mutate(bias = "high") %>%
  mutate(type = c("delib10", "consult10", "reason10", 
                  "common10", "countr10", "engage10"))

) -> anovies_pols_nondem

rbind(anovies_pols_nondem %>% 
        mutate(comparison = "Just Polity/FH Models vs. Complete Models"),
      anovies_delibs_nondem %>% 
        mutate(comparison = "Just Deliberation Models vs. Complete Models")) -> full_anovies_nondem

full_anovies_nondem %<>% 
 mutate(stars = ifelse(stars == "", "-", stars)) %>% 
 mutate(stars = case_when(
   stars == "^" ~ "p < 0.10", 
   stars == "*" ~ "p < 0.05", 
   stars == "**" ~ "p < 0.01", 
   stars == "***" ~ "p < 0.001", 
   stars == "-" ~ "n.s."
 )) %>% 
 mutate(stars = factor(stars, levels = c("n.s.", "p < 0.10", "p < 0.05", 
                                         "p < 0.01", "p < 0.001"))) %>% 
 mutate(report =  paste0("chi^2*", report)) %>% 
 mutate(bias = case_when(
   bias == "no" ~ "No Bias",
   bias == "low" ~ "Low Bias",
   bias == "high" ~ "High Bias")) %>% 
 mutate(bias = factor(bias, levels = c("No Bias", "Low Bias", "High Bias"))) %>% 
 mutate(type = case_when(
    type == "delib10" ~ "Deliberation Component Index",
    type == "reason10" ~ "Reasoned Justification",
    type == "common10" ~ "Common Good",
    type == "countr10" ~ "Counter-Arguments",
    type == "consult10" ~ "Range of Consultation",
    type == "engage10" ~ "Engaged Society"
  )) %>% 
  mutate(type = factor(type, levels = rev(c("Deliberation Component Index",
                                           "Reasoned Justification",
                                           "Common Good",
                                           "Counter-Arguments",
                                           "Range of Consultation",
                                           "Engaged Society")))) 

save(full_anovies_nondem, file = "data/full_anovies_nondem.Rdata")




```



# Try Out

```{r}
delibs <- combined %>% select(delib10, consult10, reason10, common10, countr10, engage10)

multilevels <- function(delibs) {
  result <- lmer(substitute(gov_trust_high ~ income + educ + 
               work + age + sex + i + ethnic10 + gdp10 + lifeexp10 +
               work10 + #glob10 + 
         #        poly10 + 
                 #polity_demdummy + polity_autodummy +
                 afro + latino + americas + asian + ESS +
                 (1|cntry), list(i = as.name(delibs))) , data = combined, weights = weight)
  return(result)
}  

multilevels_dem <- function(delibs) {
  result <- lmer(substitute(gov_trust_high ~ income + educ + 
               work + age + sex + i + ethnic10 + gdp10 + lifeexp10 +
               work10 + #glob10 + 
          #       poly10 + 
                 #polity_demdummy + polity_autodummy +
                 afro + latino + americas + asian + ESS +
                 (1|cntry), list(i = as.name(delibs))) , data = combined_dem, weights = weight)
  return(result)
}

multilevels_aut <- function(delibs) {
  result <- lmer(substitute(gov_trust_high ~ income + educ + 
               work + age + sex + i + ethnic10 + gdp10 + lifeexp10 +
               work10 + #glob10 + 
            #     poly10 + 
                 #polity_demdummy + polity_autodummy +
                 afro + latino + americas + asian + ESS +
                 (1|cntry), list(i = as.name(delibs))) , data = combined_aut, weights = weight)
  return(result)
}


mods_all <- names(delibs) %>% 
  purrr::map(multilevels)

mods_d <- names(delibs) %>% 
  purrr::map(multilevels_dem)

mods_a <- names(delibs) %>% 
  purrr::map(multilevels_aut)

anorder <- c("delib10", "reason10", "common10", "countr10", "consult10", "engage10")

plot_models2(listing(mods_all, mods_d, mods_a),
             thatorder = anorder,
             col_mods = c("#24C724", "#282BD4", "#F71818"),
#             plot_colors = c("green","green","green","green","blue","green",
#                             "green","blue","blue","blue","blue","blue",
#                             "red","red","red","red","red","red"),
             exponentiate = F, std.est = "std", 
             rm.terms = c("sex","income","educ", 
                           "work", "age", "sex",
            "afro", "latino", "americas", "asian", "ESS"), 
            show.values = T, show.p = T,
            labelv = -0.3, 
            labelh = -0.9, 
            labelsize = 3.2,
            geom.size = 3, geom.spacing = 0.8, 
            show.legend = F) + 
            #geom.colors = palette(rainbow(18)) + 
            theme_economist_white() + 
            theme(legend.position = "right") 

vif.mer(mods_all[[3]])

hist(combined$poly10)

fit0 <- lmer(gov_trust_high ~ income + educ + 
               work + age + sex + ethnic10 + gdp10 + lifeexp10 +
               work10 + #glob10 + 
                 polity10 + 
                 #polity_demdummy + polity_autodummy +
                 afro + latino + americas + asian + ESS + (1|cntry), data = combined, weights = weight)

plot_model(fit0)
```

