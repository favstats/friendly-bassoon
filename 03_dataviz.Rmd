---
title: "Dataviz"
output: html_notebook
---


# Loading the Packages

```{r}
library(pacman)

#p_install_gh("favstats/favstats")
p_load(tidyverse, haven,sjmisc,
                     forcats, weights, car,
                     countrycode, reshape2, 
                     magrittr, skimr, xray)

range01 <- function(x){(x-min(x, na.rm = T))/(max(x, na.rm = T)-min(x, na.rm = T))}

load("data/combined.Rdata")
```

# Heatmap

```{r}
combined


ggheatmap <- function(.data) {
  
 library(reshape2)
 
 cormat <- round(cor(.data, use = "pairwise.complete.obs"),3)
 
 # Get upper triangle of the correlation matrix
 get_upper_tri <- function(cormat){
     cormat[lower.tri(cormat)] <- NA
     return(cormat)
   }
 
 reorder_cormat <- function(cormat){
 # Use correlation between variables as distance
 dd <- as.dist((1-cormat)/2)
 hc <- hclust(dd)
 cormat <- cormat[hc$order, hc$order]
 }
 
 # Reorder the correlation matrix
 #cormat <- reorder_cormat(cormat)
 upper_tri <- get_upper_tri(cormat)
 # Melt the correlation matrix
 melted_cormat <- melt(upper_tri, na.rm = TRUE) %>% 
   mutate(value = sprintf('%.2f', value, 2)) %>% 
   mutate(value = as.numeric(value))
 # Create a ggheatmap
 ggplot(melted_cormat, aes(Var2, Var1, fill = value))+
  geom_tile(color = "white")+
  scale_fill_gradient2(low = "blue", high = "red", mid = "white", 
    midpoint = 0, limit = c(-1,1), space = "Lab", 
     name="Pearson Correlation\n") +
  ggthemes::theme_hc()+ # minimal theme
  theme(axis.text.x = element_text(angle = 45, vjust = 1, 
     size = 12, hjust = 1))+
  coord_fixed()  + 
 geom_text(aes(Var2, Var1, label = value), color = "black", size = 4) +
 theme(
   axis.title.x = element_blank(),
   axis.title.y = element_blank(),
   panel.grid.major = element_blank(),
   panel.border = element_blank(),
   panel.background = element_blank(),
   axis.ticks = element_blank(),
   legend.justification = c(1, 0),
   legend.position = c(0.7, 0.8),
   legend.title = element_text(size = 20),
   axis.ticks.length = unit(2, "cm"),
   legend.direction = "horizontal")+
   guides(fill = guide_colorbar(barwidth = 30, barheight = 1.5,
                 title.position = "top", title.hjust = 0.5))
}

combined %>% 
  select(-cntry, -survey, -n, -regime, -cntryears, -country_name, -gov_trust2) %>% 
  select(discuss:ESS, ethnic10:glob10, delibdem10:discuss_round, delib10:engage10, gov_trust, gov_trust_low, gov_trust_high) %>% 
  mutate_all(as.numeric) -> combined_heatmap

ggheatmap(combined_heatmap)

ggsave(filename = "images/heatmap.png", height = 25, width = 25)





```

# Which Control Variables?

```{r}
cormat <- round(cor(combined_heatmap, use = "pairwise.complete.obs"),3)

combined_heatmap %>% 
  mutate_all(is.na) %>% 
  summarize_all(sum) %>% 
  t() %>% 
  as.data.frame() %>% 
  rownames_to_column("cor_with") %>% 
  rename(n = V1) -> n_values

cormat %>% 
  as.data.frame() %>% 
  select(polity10, gov_trust:gov_trust_high) %>% 
  rownames_to_column("cor_with") %>% 
  left_join(n_values) %>% 
  filter(abs(polity10) < .5 &
         (abs(gov_trust) > 0.05 | 
           abs(gov_trust_low) > 0.05 | 
           abs(gov_trust_high) > 0.05)) %>% 
  arrange(n, desc(gov_trust_high), desc(gov_trust_low), desc(gov_trust))

# urbanratio10
# lifeexp10.y
# eq_health10
# eq_educ10
# directdem10
# div_power10
# equal_distrib10
# corruption10
# mortinf10
```

## Test Model

```{r}
mod1 <- lme4::lmer(gov_trust_high ~ income + educ + 
               work + age + sex +
                   ethnic10 + pop10 + lifeexp10.y +# mortinf10 + 
                 corrupt10 +
                 equal_distrib10 + eq_health10 + eq_educ10 + urbanratio10 +
                 afro + latino + americas + asian + ESS +
                 (1|cntry), data = combined, weights = weight)

texreg::screenreg(mod1)
```

